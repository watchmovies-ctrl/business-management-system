{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>ðŸ’° Sales Management</h2>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newSaleModal">
        <i class="fas fa-plus"></i> New Sale
    </button>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Invoice No</th>
                        <th>Customer</th>
                        <th>Phone</th>
                        <th>Total Amount</th>
                        <th>Payment Type</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in sales %}
                    <tr>
                        <td><strong>{{ sale[1] }}</strong></td>
                        <td>{{ sale[2] or 'Walk-in Customer' }}</td>
                        <td>{{ sale[3] or '-' }}</td>
                        <td>${{ sale[5] }}</td>
                        <td>{{ sale[6] }}</td>
                        <td>{{ sale[7] }}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewInvoice('{{ sale[4] }}')">View Items</button>
                            <a href="/print_invoice/{{ sale[1] }}" target="_blank" class="btn btn-sm btn-success ms-1">Print</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- New Sale Modal -->
<div class="modal fade" id="newSaleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ðŸ’° Create New Sale</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="saleForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Customer Name</label>
                                <input type="text" class="form-control" id="customerName">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">WhatsApp Number</label>
                                <input type="text" class="form-control" id="customerPhone" placeholder="+1234567890">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="sendWhatsApp">
                            <label class="form-check-label" for="sendWhatsApp">
                                ðŸ“± Send invoice via WhatsApp
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Type</label>
                        <select class="form-control" id="paymentType">
                            <option value="cash">Cash</option>
                            <option value="credit">Credit</option>
                            <option value="card">Card</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <h6>Items</h6>
                        <div id="itemsList">
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <input type="text" class="form-control" placeholder="Product Name" name="product_name">
                                </div>
                                <div class="col-md-2">
                                    <input type="number" class="form-control" placeholder="Qty" name="quantity">
                                </div>
                                <div class="col-md-2">
                                    <input type="number" step="0.01" class="form-control" placeholder="Price" name="price">
                                </div>
                                <div class="col-md-2">
                                    <input type="number" step="0.01" class="form-control" placeholder="Total" name="total" readonly>
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-success btn-sm" onclick="addItem()">+</button>
                                </div>
                            </div>
                        </div>
                        <div class="text-end">
                            <strong>Grand Total: $<span id="grandTotal">0.00</span></strong>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="createSale()">Create Sale</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function addItem() {
    const itemsList = document.getElementById('itemsList');
    const newItem = itemsList.children[0].cloneNode(true);
    newItem.querySelectorAll('input').forEach(input => input.value = '');
    itemsList.appendChild(newItem);
    
    const qtyInput = newItem.querySelector('input[name="quantity"]');
    const priceInput = newItem.querySelector('input[name="price"]');
    const totalInput = newItem.querySelector('input[name="total"]');
    
    function calculateTotal() {
        const qty = parseFloat(qtyInput.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        totalInput.value = (qty * price).toFixed(2);
        updateGrandTotal();
    }
    
    qtyInput.addEventListener('input', calculateTotal);
    priceInput.addEventListener('input', calculateTotal);
}

function updateGrandTotal() {
    const totals = document.querySelectorAll('input[name="total"]');
    let grandTotal = 0;
    totals.forEach(total => {
        grandTotal += parseFloat(total.value) || 0;
    });
    document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
}

function createSale() {
    const items = [];
    const itemRows = document.getElementById('itemsList').children;
    
    for (let row of itemRows) {
        const productName = row.querySelector('input[name="product_name"]').value;
        const quantity = parseFloat(row.querySelector('input[name="quantity"]').value);
        const price = parseFloat(row.querySelector('input[name="price"]').value);
        const total = parseFloat(row.querySelector('input[name="total"]').value);
        
        if (productName && quantity && price) {
            items.push({
                product_name: productName,
                quantity: quantity,
                price: price,
                total: total
            });
        }
    }
    
    const saleData = {
        customer_name: document.getElementById('customerName').value,
        customer_phone: document.getElementById('customerPhone').value,
        payment_type: document.getElementById('paymentType').value,
        send_whatsapp: document.getElementById('sendWhatsApp').checked,
        items: items
    };
    
    fetch('/create_invoice', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(saleData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            const whatsappSent = document.getElementById('sendWhatsApp').checked;
            let message = 'Sale created successfully! Invoice: ' + result.invoice_no;
            if (whatsappSent) {
                message += '\nWhatsApp message will be sent shortly!';
            }
            alert(message);
            location.reload();
        }
    });
}

function viewInvoice(itemsJson) {
    const items = JSON.parse(itemsJson);
    let itemsText = 'Items:\n';
    items.forEach(item => {
        itemsText += `${item.product_name} - Qty: ${item.quantity}, Price: $${item.price}, Total: $${item.total}\n`;
    });
    alert(itemsText);
}

document.addEventListener('DOMContentLoaded', function() {
    const firstRow = document.getElementById('itemsList').children[0];
    const qtyInput = firstRow.querySelector('input[name="quantity"]');
    const priceInput = firstRow.querySelector('input[name="price"]');
    
    function calculateTotal() {
        const qty = parseFloat(qtyInput.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        firstRow.querySelector('input[name="total"]').value = (qty * price).toFixed(2);
        updateGrandTotal();
    }
    
    qtyInput.addEventListener('input', calculateTotal);
    priceInput.addEventListener('input', calculateTotal);
});
</script>
{% endblock %}