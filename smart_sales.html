{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12 text-center">
        <h2 class="display-5 fw-bold text-white mb-3">Smart Sales Management</h2>
        <button class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#newSaleModal">
            <i class="fas fa-plus me-2"></i>Create New Sale
        </button>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Sales History</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Invoice</th>
                        <th>Customer</th>
                        <th>Phone</th>
                        <th>Amount</th>
                        <th>Payment</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in sales %}
                    <tr>
                        <td><strong class="text-primary">{{ sale[1] }}</strong></td>
                        <td>{{ sale[2] or 'Walk-in Customer' }}</td>
                        <td>{{ sale[3] or '-' }}</td>
                        <td><span class="badge bg-success fs-6">PKR {{ "%.2f"|format(sale[5]) }}</span></td>
                        <td>
                            <span class="badge {% if sale[6] == 'credit' %}bg-warning{% else %}bg-info{% endif %}">
                                {{ sale[6]|title }}
                            </span>
                        </td>
                        <td>{{ sale[7] }}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-info" onclick="viewInvoice('{{ sale[4] }}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <a href="/print_invoice/{{ sale[1] }}" target="_blank" class="btn btn-sm btn-outline-success">
                                <i class="fas fa-print"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Smart Sale Modal -->
<div class="modal fade" id="newSaleModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-shopping-cart me-2"></i>Create Smart Sale</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="saleForm">
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Customer Name</label>
                            <input type="text" class="form-control" id="customerName">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">WhatsApp Number</label>
                            <input type="text" class="form-control" id="customerPhone" placeholder="+1234567890">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Payment Type</label>
                            <select class="form-control" id="paymentType" onchange="toggleOnlinePayment()">
                                <option value="cash">Cash</option>
                                <option value="credit">Credit</option>
                                <option value="card">Card</option>
                                <option value="online">Online Payment</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="sendWhatsApp">
                            <label class="form-check-label fw-bold" for="sendWhatsApp">
                                <i class="fab fa-whatsapp me-1 text-success"></i>Send invoice via WhatsApp
                            </label>
                        </div>
                    </div>
                    
                    <!-- Online Payment Section -->
                    <div id="onlinePaymentSection" class="mb-3" style="display: none;">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-credit-card me-2"></i>Online Payment</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Payment Method</label>
                                        <select class="form-control" id="onlineMethod">
                                            <option value="stripe">Credit/Debit Card</option>
                                            <option value="paypal">PayPal</option>
                                            <option value="bank">Bank Transfer</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Customer Email</label>
                                        <input type="email" class="form-control" id="customerEmail" placeholder="customer@email.com">
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button type="button" class="btn btn-primary" onclick="processOnlinePayment()">
                                        <i class="fas fa-credit-card me-1"></i>Process Payment
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-list me-2"></i>Invoice Items (Auto-Price)</h6>
                        </div>
                        <div class="card-body">
                            <div id="itemsList">
                                <div class="row g-2 mb-2 align-items-end">
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">Product Name</label>
                                        <input type="text" class="form-control" placeholder="Enter product name" name="product_name" onblur="fetchProductInfo(this)">
                                        <div class="invalid-feedback"></div>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label fw-bold">Quantity</label>
                                        <input type="number" class="form-control" placeholder="Qty" name="quantity" min="1">
                                        <small class="text-muted">Available: <span class="available-qty">-</span></small>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label fw-bold">Price (Auto)</label>
                                        <input type="number" step="0.01" class="form-control bg-light" name="price" readonly>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label fw-bold">Total</label>
                                        <input type="number" step="0.01" class="form-control bg-light" name="total" readonly>
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-success w-100" onclick="addItem()">
                                            <i class="fas fa-plus me-1"></i>Add Item
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="text-end mt-3">
                                <h4 class="text-success">Grand Total: PKR <span id="grandTotal">0.00</span></h4>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success btn-lg" onclick="createSale()">
                    <i class="fas fa-check me-1"></i>Create Sale
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function fetchProductInfo(input) {
    const productName = input.value.trim();
    const row = input.closest('.row');
    const priceInput = row.querySelector('input[name="price"]');
    const availableQtySpan = row.querySelector('.available-qty');
    const quantityInput = row.querySelector('input[name="quantity"]');
    
    if (!productName) {
        priceInput.value = '';
        availableQtySpan.textContent = '-';
        input.classList.remove('is-invalid', 'is-valid');
        return;
    }
    
    fetch(`/get_product_info/${encodeURIComponent(productName)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                priceInput.value = data.price;
                availableQtySpan.textContent = data.available_qty;
                input.classList.remove('is-invalid');
                input.classList.add('is-valid');
                
                // Set max quantity
                quantityInput.max = data.available_qty;
                
                // Calculate total if quantity exists
                if (quantityInput.value) {
                    calculateTotal(row);
                }
            } else {
                priceInput.value = '';
                availableQtySpan.textContent = '0';
                input.classList.remove('is-valid');
                input.classList.add('is-invalid');
                input.nextElementSibling.textContent = data.message;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            input.classList.add('is-invalid');
            input.nextElementSibling.textContent = 'Error fetching product info';
        });
}

function calculateTotal(row) {
    const qtyInput = row.querySelector('input[name="quantity"]');
    const priceInput = row.querySelector('input[name="price"]');
    const totalInput = row.querySelector('input[name="total"]');
    const availableQty = parseInt(row.querySelector('.available-qty').textContent) || 0;
    
    const qty = parseFloat(qtyInput.value) || 0;
    const price = parseFloat(priceInput.value) || 0;
    
    // Validate quantity against available stock
    if (qty > availableQty && availableQty > 0) {
        qtyInput.classList.add('is-invalid');
        showError(`Only ${availableQty} items available in stock!`);
        qtyInput.value = Math.min(qty, availableQty);
        const newQty = parseFloat(qtyInput.value);
        totalInput.value = (newQty * price).toFixed(2);
    } else {
        qtyInput.classList.remove('is-invalid');
        totalInput.value = (qty * price).toFixed(2);
    }
    
    updateGrandTotal();
}

function addItem() {
    const itemsList = document.getElementById('itemsList');
    const newItem = itemsList.children[0].cloneNode(true);
    
    // Clear inputs and reset state
    newItem.querySelectorAll('input').forEach(input => {
        input.value = '';
        input.classList.remove('is-valid', 'is-invalid');
    });
    newItem.querySelector('.available-qty').textContent = '-';
    
    // Remove any existing suggestions
    const suggestions = newItem.querySelector('.suggestions');
    if (suggestions) suggestions.remove();
    
    // Change button to remove
    const button = newItem.querySelector('button');
    button.innerHTML = '<i class="fas fa-trash me-1"></i>Remove';
    button.className = 'btn btn-danger w-100';
    button.onclick = function() { 
        if (itemsList.children.length > 1) {
            this.closest('.row').remove(); 
            updateGrandTotal();
        } else {
            showError('At least one item row is required!');
        }
    };
    
    itemsList.appendChild(newItem);
    
    // Add event listeners
    const productInput = newItem.querySelector('input[name="product_name"]');
    const qtyInput = newItem.querySelector('input[name="quantity"]');
    
    productInput.onblur = function() { fetchProductInfo(this); };
    qtyInput.oninput = function() { calculateTotal(this.closest('.row')); };
    
    // Setup autocomplete for new input
    if (window.stockData) {
        productInput.addEventListener('input', function() {
            const value = this.value.toLowerCase();
            if (value.length > 1) {
                const matches = window.stockData.filter(item => 
                    item.product_name.toLowerCase().includes(value)
                ).slice(0, 5);
                showSuggestions(this, matches);
            }
        });
    }
    
    // Focus on new product input
    productInput.focus();
}

function updateGrandTotal() {
    const totals = document.querySelectorAll('input[name="total"]');
    let grandTotal = 0;
    totals.forEach(total => {
        const value = parseFloat(total.value) || 0;
        grandTotal += value;
    });
    document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
    
    // Update the total display with currency
    const totalDisplay = document.getElementById('grandTotal');
    if (totalDisplay) {
        totalDisplay.style.color = grandTotal > 0 ? '#28a745' : '#6c757d';
        totalDisplay.style.fontWeight = 'bold';
    }
}

function createSale() {
    const items = [];
    const itemRows = document.getElementById('itemsList').children;
    
    // Validate and collect items
    for (let row of itemRows) {
        const productName = row.querySelector('input[name="product_name"]').value.trim();
        const quantity = parseFloat(row.querySelector('input[name="quantity"]').value);
        const price = parseFloat(row.querySelector('input[name="price"]').value);
        const total = parseFloat(row.querySelector('input[name="total"]').value);
        
        if (productName && quantity > 0 && price > 0) {
            items.push({
                product_name: productName,
                quantity: quantity,
                price: price,
                total: total
            });
        }
    }
    
    if (items.length === 0) {
        showError('Please add at least one valid item to the invoice!');
        return;
    }
    
    // Validate customer info for credit sales
    const paymentType = document.getElementById('paymentType').value;
    const customerName = document.getElementById('customerName').value.trim();
    
    if (paymentType === 'credit' && !customerName) {
        showError('Customer name is required for credit sales!');
        return;
    }
    
    const saleData = {
        customer_name: customerName || 'Walk-in Customer',
        customer_phone: document.getElementById('customerPhone').value.trim(),
        payment_type: paymentType,
        send_whatsapp: document.getElementById('sendWhatsApp').checked,
        items: items
    };
    
    // Show loading
    const createBtn = event.target;
    const originalText = createBtn.innerHTML;
    createBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creating Sale...';
    createBtn.disabled = true;
    
    fetch('/simple_create_sale', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(saleData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            const whatsappSent = document.getElementById('sendWhatsApp').checked;
            let message = `Sale created successfully!\nInvoice: ${result.invoice_no}\nTotal: PKR ${result.total}`;
            
            if (whatsappSent && saleData.customer_phone) {
                message += '\n\nWhatsApp invoice will open shortly!';
            }
            
            showSuccess(message);
            
            // Close modal and reload
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('newSaleModal'));
                modal.hide();
                location.reload();
            }, 2000);
        } else {
            showError('Error creating sale: ' + (result.errors ? result.errors.join(', ') : 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Network error occurred. Please try again.');
    })
    .finally(() => {
        createBtn.innerHTML = originalText;
        createBtn.disabled = false;
    });
}

function viewInvoice(itemsJson) {
    const items = JSON.parse(itemsJson);
    let itemsText = 'ðŸ“‹ Invoice Items:\n\n';
    items.forEach(item => {
        itemsText += `â€¢ ${item.product_name} - Qty: ${item.quantity}, Price: PKR ${item.price}, Total: PKR ${item.total}\n`;
    });
    alert(itemsText);
}

function toggleOnlinePayment() {
    const paymentType = document.getElementById('paymentType').value;
    const onlineSection = document.getElementById('onlinePaymentSection');
    
    if (paymentType === 'online') {
        onlineSection.style.display = 'block';
    } else {
        onlineSection.style.display = 'none';
    }
}

function processOnlinePayment() {
    const grandTotal = document.getElementById('grandTotal').textContent;
    const method = document.getElementById('onlineMethod').value;
    const email = document.getElementById('customerEmail').value;
    
    if (!email) {
        alert('Please enter customer email for online payment');
        return;
    }
    
    // Simulate payment processing
    const paymentData = {
        amount: parseFloat(grandTotal),
        method: method,
        email: email
    };
    
    // Show payment processing
    const btn = event.target;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
    btn.disabled = true;
    
    // Simulate payment gateway
    setTimeout(() => {
        if (method === 'stripe') {
            // Open Stripe-like payment
            const paymentUrl = `https://checkout.stripe.com/pay?amount=${paymentData.amount * 100}&email=${email}`;
            window.open(paymentUrl, '_blank', 'width=600,height=700');
        } else if (method === 'paypal') {
            // Open PayPal-like payment
            const paypalUrl = `https://www.paypal.com/checkout?amount=${paymentData.amount}&email=${email}`;
            window.open(paypalUrl, '_blank', 'width=600,height=700');
        } else {
            // Bank transfer info
            alert(`Bank Transfer Details:\nAmount: PKR ${paymentData.amount}\nAccount: 1234567890\nRouting: 987654321`);
        }
        
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Payment Sent';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');
    }, 2000);
}

// Initialize first row and load stock data
document.addEventListener('DOMContentLoaded', function() {
    const firstRow = document.getElementById('itemsList').children[0];
    const qtyInput = firstRow.querySelector('input[name="quantity"]');
    qtyInput.oninput = function() { calculateTotal(this.closest('.row')); };
    
    // Load available stock for autocomplete
    loadStockData();
});

// Load stock data for autocomplete
function loadStockData() {
    fetch('/get_all_stock')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.stockData = data.stock;
                setupAutocomplete();
            }
        })
        .catch(error => console.error('Error loading stock:', error));
}

// Setup autocomplete for product names
function setupAutocomplete() {
    const productInputs = document.querySelectorAll('input[name="product_name"]');
    productInputs.forEach(input => {
        input.addEventListener('input', function() {
            const value = this.value.toLowerCase();
            if (value.length > 1 && window.stockData) {
                const matches = window.stockData.filter(item => 
                    item.product_name.toLowerCase().includes(value)
                ).slice(0, 5);
                
                showSuggestions(this, matches);
            }
        });
    });
}

// Show product suggestions
function showSuggestions(input, matches) {
    // Remove existing suggestions
    const existingSuggestions = input.parentNode.querySelector('.suggestions');
    if (existingSuggestions) {
        existingSuggestions.remove();
    }
    
    if (matches.length === 0) return;
    
    const suggestions = document.createElement('div');
    suggestions.className = 'suggestions position-absolute bg-white border rounded shadow-sm';
    suggestions.style.cssText = 'top: 100%; left: 0; right: 0; z-index: 1000; max-height: 200px; overflow-y: auto;';
    
    matches.forEach(item => {
        const suggestion = document.createElement('div');
        suggestion.className = 'p-2 border-bottom cursor-pointer';
        suggestion.style.cursor = 'pointer';
        suggestion.innerHTML = `<strong>${item.product_name}</strong><br><small>Stock: ${item.quantity} | Price: PKR ${item.selling_price}</small>`;
        
        suggestion.addEventListener('click', function() {
            input.value = item.product_name;
            fetchProductInfo(input);
            suggestions.remove();
        });
        
        suggestion.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f8f9fa';
        });
        
        suggestion.addEventListener('mouseleave', function() {
            this.style.backgroundColor = 'white';
        });
        
        suggestions.appendChild(suggestion);
    });
    
    input.parentNode.style.position = 'relative';
    input.parentNode.appendChild(suggestions);
    
    // Remove suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!input.parentNode.contains(e.target)) {
            suggestions.remove();
        }
    }, { once: true });
}
</script>
{% endblock %}